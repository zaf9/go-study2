# 日志最佳实践

以下为日志系统使用与编写日志的最佳实践，供开发者遵循以保证可观测性与合规性（中文说明 - 必须）。

1. 日志级别与语义
   - DEBUG：仅在本地或调试环境记录，包含详细上下文与内部状态。
   - INFO：业务流程关键节点（如用户登录、任务完成、重要配置变更）。
   - WARN：可恢复或需关注的问题（如第三方服务延迟、降级事件）。
   - ERROR：业务失败或不可恢复错误，需尽快排查（记录堆栈信息）。

2. 结构化日志字段
   - 建议输出 JSON 结构化日志（便于后续集中化收集与检索）：{
     - timestamp（时间戳）, level（级别）, trace_id（TraceID）, msg（消息）, ctx（上下文对象）
   }
   - 避免在消息文本中嵌入大量结构化字段，应放入 ctx 字段。

3. TraceID 使用
   - 在 HTTP 请求入口（中间件）生成或提取 TraceID，并注入 Context，确保所有下游日志携带相同 TraceID。
   - TraceID 应长度适中（例如 16-32 字节），可携带可读前缀（如服务名）。

4. 慢查询与敏感信息
   - 慢查询阈值在配置中设置，记录慢查询时包含 SQL、耗时、参数摘要，但**必须脱敏**：不得记录完整密码、token 等敏感值。
   - 对可能含敏感信息的参数进行掩码处理（见脱敏策略）。

5. 日志容量与分割策略
   - 使用按日 + 按大小的轮转策略，保留策略通过配置控制（例如：保留最近 N 天或最大占用空间）。
   - 日志清理应由后台进程或启动时调度完成，避免长期占满磁盘。

6. 查询与可观测性
   - 为常见查询（TraceID、时间范围、级别）提供高效流式扫描或索引支持（当数据量大时考虑 ELK/Prometheus/Tempo 等方案）。

7. 开发者守则
   - 在关键业务点记录业务标识（user_id、resource_id），但遵守隐私与脱敏策略。
   - 写日志时尽量提供可追溯的上下文，避免仅记录模糊信息（如“失败”）。
