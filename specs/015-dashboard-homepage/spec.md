# Feature Specification: Dashboard 首页功能

<!--
  NOTE: Per the constitution, all user-facing documentation and code comments
  must be in Chinese.
-->

**Feature Branch**: `015-dashboard-homepage`  
**Created**: 2025-12-26  
**Status**: Draft  
**Input**: User description: "Dashboard 首页功能需求 - 创建真正的 Dashboard 首页，提供学习状态概览、快速继续学习、主题进度可视化、测验记录等功能"

## Constitution Guardrails

本功能遵循以下关键宪法原则（详细检查见 [plan.md](./plan.md) Constitution Check 章节）：

- **代码质量** (Principle I/IV/XVI): 单一职责、浅层逻辑、可维护性
- **错误处理** (Principle II): 显式处理，无静默失败
- **测试覆盖** (Principle III): 前后端核心代码 ≥80%
- **中文文档** (Principle V/XX): 注释与用户文档全中文
- **YAGNI** (Principle VI): 避免过度设计
- **安全优先** (Principle VII): 输入校验、鉴权、HTTPS
- **依赖纪律** (Principle IX): 最小化外部依赖
- **文档同步** (Principle XI): 完成后更新 README

## User Scenarios & Testing *(mandatory)*

<!--
  NOTE: Per the constitution, all features must achieve at least 80% unit test coverage.
  Ensure acceptance scenarios are comprehensive enough to meet this requirement.
-->

### User Story 1 - 学习状态快速概览 (Priority: P1)

作为 Go 语言学习者，我想要登录后立即看到我的学习概况（欢迎信息、累计学习天数、总章节完成进度、整体完成百分比），以便于快速了解我的进度并决定接下来学什么。

**Why this priority**: 这是 Dashboard 的核心价值，为用户提供一目了然的学习状态，是最基础且最重要的功能。没有这个功能，Dashboard 就失去了存在的意义。

**Independent Test**: 可以通过访问 Dashboard 页面并验证显示的统计数据（学习天数、完成章节数、百分比）与数据库中的实际记录一致来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户已登录且有学习记录，**When** 访问 Dashboard 首页，**Then** 显示欢迎信息（含用户名）、累计学习天数、已完成章节数/总章节数、整体完成百分比
2. **Given** 用户已登录但无任何学习记录（新用户），**When** 访问 Dashboard 首页，**Then** 显示欢迎信息、学习天数为 0、完成进度为 0/总数、百分比为 0%
3. **Given** 用户已登录且完成了部分章节，**When** 访问 Dashboard 首页，**Then** 显示的完成百分比 = (已完成章节数 / 总章节数) × 100%，精确到小数点后一位
4. **Given** 用户已登录，**When** Dashboard 页面加载，**Then** 所有统计数据在 2 秒内完成加载并显示

---

### User Story 2 - 一键继续学习 (Priority: P1)

作为 Go 语言学习者，我想要一键继续上次未完成的学习内容（显示最后一次学习的主题和章节，点击后直接跳转到该章节的学习页面），以便于无需记忆和查找就能快速恢复学习状态。

**Why this priority**: 这是提升用户体验的关键功能，减少用户的认知负担和操作步骤，直接影响用户的学习连续性和积极性。

**Independent Test**: 可以通过记录用户最后访问的章节，然后在 Dashboard 上点击"继续学习"按钮，验证是否正确跳转到该章节页面来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户已登录且有学习记录，**When** 访问 Dashboard 首页，**Then** 显示"继续学习"区域，包含最后一次学习的主题名称和章节名称
2. **Given** 用户已登录且有学习记录，**When** 点击"继续学习"按钮或卡片，**Then** 直接跳转到最后一次学习的章节详情页面
3. **Given** 用户已登录但无任何学习记录（新用户），**When** 访问 Dashboard 首页，**Then** 显示引导信息（如"开始你的 Go 学习之旅"）和"开始学习"按钮，点击后跳转到主题列表页面
4. **Given** 用户已登录且最后学习记录的章节已被删除或不可用，**When** 访问 Dashboard 首页，**Then** 显示友好的提示信息，并提供跳转到主题列表的选项

---

### User Story 3 - 主题进度可视化 (Priority: P2)

作为 Go 语言学习者，我想要在首页看到各主题的学习进度（列出所有可学习的主题，每个主题显示其完成百分比，使用进度条可视化展示完成度），以便于快速选择薄弱环节进行针对性学习。

**Why this priority**: 这个功能帮助用户识别学习薄弱点，但不如整体概览和快速继续功能那么紧迫。用户可以先通过 P1 功能开始学习，再通过这个功能优化学习路径。

**Independent Test**: 可以通过创建多个主题的学习记录（部分完成、全部完成、未开始），然后在 Dashboard 上验证每个主题的进度条和百分比是否正确显示来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户已登录，**When** 访问 Dashboard 首页，**Then** 显示所有可学习的主题列表（Lexical Elements, Constants, Variables, Types 等）
2. **Given** 用户已登录且某个主题有学习进度，**When** 查看该主题卡片，**Then** 显示该主题的完成百分比和可视化进度条
3. **Given** 用户已登录且某个主题未开始学习，**When** 查看该主题卡片，**Then** 显示 0% 进度和空进度条
4. **Given** 用户已登录且某个主题已完成所有章节，**When** 查看该主题卡片，**Then** 显示 100% 进度和满进度条
5. **Given** 用户已登录，**When** 点击任意主题卡片，**Then** 跳转到该主题的章节列表页面

---

### User Story 4 - 最近测验记录展示 (Priority: P3)

作为 Go 语言学习者，我想要看到最近的测验记录（列出最近 3-5 条测验记录，每条记录显示主题/章节名称、得分、完成时间），以便于了解我的知识掌握情况。

**Why this priority**: 这是一个增强功能，提供额外的学习反馈，但不影响核心学习流程。用户可以通过专门的测验页面查看详细记录，Dashboard 上的展示是锦上添花。

**Independent Test**: 可以通过完成几次测验，然后在 Dashboard 上验证是否显示最近的测验记录（按时间倒序排列，最多 5 条）来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户已登录且有测验记录，**When** 访问 Dashboard 首页，**Then** 显示最近 3-5 条测验记录，按完成时间倒序排列
2. **Given** 用户已登录且有测验记录，**When** 查看测验记录卡片，**Then** 每条记录显示主题/章节名称、得分（如 85/100）、完成时间（如"2 小时前"或"2025-12-26 10:30"）
3. **Given** 用户已登录但无测验记录，**When** 访问 Dashboard 首页，**Then** 显示引导提示（如"还没有测验记录，开始第一次测验吧"）和"开始测验"按钮
4. **Given** 用户已登录且有测验记录，**When** 点击某条测验记录，**Then** 跳转到该测验的详情页面（如果存在）
5. **Given** 用户已登录且测验记录超过 5 条，**When** 访问 Dashboard 首页，**Then** 只显示最近的 5 条记录，并提供"查看全部"链接跳转到测验历史页面。**如测验历史页面不存在，则不显示"查看全部"链接，仅显示最近 5 条。**

---

### User Story 5 - 路由与导航调整 (Priority: P1)

作为 Go 语言学习者，我想要登录后默认跳转到 Dashboard 首页（而非当前的 `/topics`），并且侧边栏的"首页"按钮链接指向 Dashboard 页面，以便于获得更好的导航体验。

**Why this priority**: 这是实现 Dashboard 功能的前提条件，必须与 User Story 1 同步完成，否则用户无法访问 Dashboard。

**Independent Test**: 可以通过登录系统并验证是否自动跳转到 Dashboard 页面，以及点击侧边栏"首页"按钮是否跳转到 Dashboard 来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户未登录，**When** 成功登录，**Then** 自动跳转到 Dashboard 首页（路径为 `/` 或 `/dashboard`）
2. **Given** 用户已登录，**When** 点击侧边栏的"首页"按钮，**Then** 跳转到 Dashboard 首页
3. **Given** 用户已登录，**When** 点击侧边栏的"学习主题"按钮，**Then** 跳转到主题列表页面（`/topics`）
4. **Given** 用户已登录并在其他页面，**When** 点击侧边栏的"首页"按钮，**Then** 跳转到 Dashboard 首页，且 Dashboard 数据刷新显示最新状态

---

### Edge Cases

- 当用户的学习记录数据不完整或损坏时（如章节 ID 不存在），Dashboard 如何处理？应显示友好的错误提示，不应崩溃或显示空白页面。
- 当系统中没有任何主题或章节数据时（如初始化阶段），Dashboard 如何显示？应显示"暂无学习内容"的提示。
- 当用户的学习记录跨越多个版本（如章节结构发生变化）时，如何计算准确的进度？应基于当前可用的章节数据计算，忽略已删除的章节。
- 当 Dashboard 数据加载失败（如 API 超时或返回错误）时，如何处理？应显示错误提示和重试按钮，不应无限加载或静默失败。
- 当用户在多个设备上同时学习时，Dashboard 数据如何保持一致？应基于服务器端的最新数据，每次访问时重新加载。
- 当主题或章节名称过长时，UI 如何显示？应使用省略号截断，并提供 tooltip 显示完整名称。
- 当用户的学习天数计算跨越时区时，如何处理？应基于服务器端的统一时区计算，或使用用户本地时区（需明确策略）。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在用户登录后默认跳转到 Dashboard 首页（路径为 `/`）
- **FR-002**: 系统必须在 Dashboard 首页显示欢迎信息，包含当前登录用户的用户名
- **FR-003**: 系统必须在 Dashboard 首页显示用户的累计学习天数。**计算规则：有学习活动的不同日期数（非连续天数），基于服务器时区 UTC+8。**（具体 SQL 实现见 [data-model.md](./data-model.md)）
- **FR-004**: 系统必须在 Dashboard 首页显示用户的总章节完成进度，格式为"已完成章节数 / 总章节数"。**总章节数 = 系统中所有已发布的学习章节数（不考虑权限限制）。**
- **FR-005**: 系统必须在 Dashboard 首页显示用户的整体完成百分比，计算公式为 (已完成章节数 / 总章节数) × 100%，精确到小数点后一位
- **FR-006**: 系统必须提供 `/api/progress/last` 接口，返回用户最后一次学习的主题和章节信息
- **FR-007**: 系统必须在 Dashboard 首页显示"快速继续"功能区域，包含最后一次学习的主题名称和章节名称（通过 `/api/progress/last` 接口获取）
- **FR-008**: 系统必须在用户点击"快速继续"按钮时，直接跳转到最后一次学习的章节详情页面
- **FR-009**: 系统必须在用户无学习记录时，显示引导信息和"开始学习"按钮，点击后跳转到主题列表页面
- **FR-010**: 系统必须在 Dashboard 首页显示所有可学习的主题列表，每个主题显示名称、完成百分比和可视化进度条。**主题按课程中的学习顺序排列（即主题定义的顺序字段或默认创建顺序）。**
- **FR-011**: 系统必须在用户点击主题卡片时，跳转到该主题的章节列表页面
- **FR-012**: 系统必须在 Dashboard 首页显示最近 3-5 条测验记录，按完成时间倒序排列
- **FR-013**: 系统必须在每条测验记录中显示主题/章节名称、得分和完成时间。**时间格式：24 小时内显示相对时间如"2 小时前"，超过 24 小时显示绝对时间如"2025-12-26 10:30"。后端 API 返回 ISO 8601 格式，格式化由前端实现。**
- **FR-014**: 系统必须在用户无测验记录时，显示引导提示和"开始测验"按钮。**点击后跳转到主题列表页面 (`/topics`)，由用户选择主题后开始测验。**
- **FR-015**: 系统必须在用户点击测验记录时，跳转到该测验的详情页面（如果详情页面存在）
- **FR-016**: 系统必须在侧边栏的"首页"按钮链接指向 Dashboard 首页（路径为 `/`）
- **FR-017**: 系统必须保持侧边栏的"学习主题"按钮独立，指向主题列表页面（`/topics`）
- **FR-018**: 系统必须通过 WebSocket 连接实现 Dashboard 数据的实时推送更新，支持以下事件类型：
  - `progress_updated`: 学习进度更新事件，包含 JSON 数据 `{event: "progress_updated", data: {user_id, topic_id, chapter_id, completed, timestamp}}`
  - `quiz_completed`: 测验完成事件，包含 JSON 数据 `{event: "quiz_completed", data: {user_id, quiz_id, score, timestamp}}`
- **FR-019**: 系统必须在 WebSocket 连接断开时，使用指数退避策略自动尝试重新连接（初始间隔 1 秒，最大间隔 30 秒，最多重试 5 次），并在连接失败时显示友好的错误提示。**5 次重试失败后，显示错误提示"无法连接实时更新服务，请刷新页面重试"并提供手动刷新按钮。**
- **FR-020**: 系统必须在 Dashboard 页面初始加载时，在 2 秒内完成所有数据的加载并显示。**定义：首次内容绘制 (FCP) < 1.5 秒，所有 API 数据返回 < 2 秒，WebSocket 连接不阻塞页面渲染（异步建立）。**
- **FR-021**: 系统必须在 Dashboard 数据加载失败时，显示友好的错误提示和重试按钮
- **FR-022**: 系统必须在最后学习记录的章节不可用时，显示友好的提示信息并提供跳转到主题列表的选项
- **FR-023**: 系统必须在主题或章节名称过长时，使用省略号截断并提供 tooltip 显示完整名称。**使用 Ant Design Tooltip 组件，鼠标悬停 300ms 后自动显示。**
- **FR-024**: 系统必须使用现有的身份验证机制（JWT 或 Session）保护 Dashboard 相关的所有 API 端点和 WebSocket 连接

### Key Entities

- **学习进度记录 (Learning Progress)**: 记录用户对每个章节的学习状态，包含用户 ID、主题 ID、章节 ID、完成状态、最后学习时间等属性
- **主题 (Topic)**: 代表一个学习主题（如 Lexical Elements, Constants），包含主题 ID、主题名称、章节列表等属性
- **章节 (Chapter)**: 代表主题下的一个学习章节，包含章节 ID、章节名称、所属主题 ID、内容等属性
- **测验记录 (Quiz Record)**: 记录用户的测验历史，包含用户 ID、主题/章节 ID、得分、完成时间等属性
- **用户 (User)**: 代表学习者，包含用户 ID、用户名、注册时间等属性

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能在 3 秒内理解自己的整体学习状态（通过查看 Dashboard 上的关键指标）
- **SC-002**: 80% 以上的用户使用"快速继续"功能恢复学习（通过点击率统计）
- **SC-003**: Dashboard 页面成为用户最常访问的页面之一（访问量排名前 3）
- **SC-004**: Dashboard 页面加载时间在 2 秒内完成（在正常网络条件下）
- **SC-005**: 用户反馈导航清晰度提升（通过用户调研或反馈收集）
- **SC-006**: Dashboard 显示的进度数据与实际学习记录的一致性达到 100%（无数据偏差）
- **SC-007**: Dashboard 在移动端、平板、桌面等不同设备上均能正常显示和交互（响应式设计验证）
- **SC-008**: 新用户（无学习记录）能在 5 秒内理解如何开始学习（通过引导信息和按钮）

## Assumptions

- 假设现有的进度统计 API 能够提供用户的学习记录数据（已完成章节等）
- 假设现有的测验记录 API 能够提供用户的测验历史数据（得分、完成时间等）
- 假设现有的主题列表 API 能够提供所有可学习的主题和章节数据
- 假设用户的学习天数计算基于服务器端的统一时区（如 UTC+8），确保跨设备一致性
- 假设"本周学习时长"数据暂不可用，使用"本周完成章节数"作为替代指标（更易实现且同样有效）
- 假设后端支持 WebSocket 连接，用于实时推送 Dashboard 数据更新（学习进度变化、新测验记录等）
- 假设 WebSocket 连接断开后，系统能够自动重连，并在重连失败时降级到页面刷新模式
- 假设用户登录后的默认路由可以通过前端路由配置进行调整为根路径 `/`
- 假设现有的 Ant Design 组件库能够满足 Dashboard 的 UI 设计需求
- 假设新用户（无学习记录）通过 Dashboard 上的内联引导信息和"开始学习"按钮即可理解如何开始，无需特殊的欢迎页面（遵循简洁设计原则）
- 假设如果测验记录的详情页面不存在，则测验记录卡片不可点击，仅作为信息展示（优雅降级）
- 假设系统已有完善的身份验证机制（JWT 或 Session），Dashboard 功能将复用该机制进行用户认证和授权

## Dependencies

- 现有的进度统计 API（用于获取用户的学习记录和完成进度）
- 现有的测验记录 API（用于获取用户的测验历史）
- 现有的主题列表 API（用于获取所有可学习的主题和章节）
- **新增**: `/api/progress/last` 接口（需要后端开发，返回用户最后一次学习的主题和章节信息，包括主题 ID、主题名称、章节 ID、章节名称、最后学习时间）
- **新增**: WebSocket 服务端支持（需要后端开发，用于实时推送 Dashboard 数据更新，包括学习进度变化、新测验记录等）
- 前端路由配置（用于调整登录后的默认跳转路径为 `/`）
- 侧边栏导航组件（用于更新"首页"按钮的链接指向 `/`）

## Constraints

- 必须与现有设计风格（Ant Design）保持一致
- 不应破坏现有页面的功能和导航
- 应尽可能复用现有组件和 API，避免重复开发
- Dashboard 页面必须支持响应式设计，适配桌面、平板、手机等不同设备
- Dashboard 数据的准确性必须与实际学习记录一致，不允许数据偏差
- Dashboard 页面初始加载时间必须在 2 秒内（在正常网络条件下）
- WebSocket 连接必须处理网络不稳定情况，提供自动重连和降级机制
- 根路径 `/` 的使用不应与现有路由冲突，需要妥善处理路由优先级

## Decisions Made

以下问题已通过用户决策解决：

1. **最后学习记录的 API**: 需要新增 `/api/progress/last` 接口，返回用户最后一次学习的主题和章节信息（包括主题 ID、主题名称、章节 ID、章节名称、最后学习时间）
2. **Dashboard 路径**: 使用根路径 `/` 作为 Dashboard 首页，更符合用户习惯且 URL 简洁
3. **数据刷新策略**: 使用 WebSocket 实现实时数据推送，确保多设备学习时数据同步，提供最佳用户体验。WebSocket 连接断开时自动重连，重连失败时降级到页面刷新模式

## Clarifications

### Session 2025-12-26

- Q: WebSocket 事件类型与数据格式如何定义？ → A: 定义具体事件类型（progress_updated, quiz_completed）和 JSON 格式
- Q: 用户身份验证与会话管理如何处理？ → A: 使用现有的身份验证机制（JWT/Session）
- Q: WebSocket 重连策略的具体参数是什么？ → A: 指数退避（初始间隔 1 秒，最大间隔 30 秒，最多重试 5 次）
- Q: 学习天数计算的具体规则是什么？ → A: 计算有学习活动的不同日期数（非连续天数）
- Q: 测验记录显示的时间格式是什么？ → A: 相对时间（24 小时内）+ 绝对时间（超过 24 小时）
